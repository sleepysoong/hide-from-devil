# -----------------------------------------------------------------
#   PyArmor â†’ nukita ë¡œ ë‚œë…í™” í›„ Release ë¥¼ ìë™ìœ¼ë¡œ ë§Œë“ ë‹¤
#   - ë²„íŠ¼ í´ë¦­ â†’ workflow_dispatch ë¡œ ì‹¤í–‰
#   - VERSION íŒŒì¼ â†’ íƒœê·¸ ìƒì„±/ì‚­ì œ
#   - ê¸°ì¡´ íƒœê·¸ ìˆìœ¼ë©´ ì‚­ì œ
#   - PyArmor â†’ nukita â†’ ìƒˆ íƒœê·¸
#   - Release ì— ì•„í‹°íŒ©íŠ¸ ì²¨ë¶€ & ìš´ì˜ì²´ì œ ë³„ ì‹¤í–‰ë²• ê¸°ë¡
# -----------------------------------------------------------------
name: Obfuscate & Release

# âœ… ìˆ˜ë™(ë²„íŠ¼) íŠ¸ë¦¬ê±°
on:
  workflow_dispatch:   # GitHub UI ì—ì„œ â€˜Run workflowâ€™ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹¤í–‰

# Release, push íƒœê·¸ ë“±ì„ í•  ìˆ˜ ìˆê²Œ ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write      # Release / tag creation, artifact upload ì— í•„ìš”

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:

      # -------------------------------------------------------------
      # 1ï¸âƒ£ ë ˆí¬ í´ë¡  (íƒœê·¸ë„ ëª¨ë‘ ë°›ì•„ì™€ì•¼ ì‚­ì œ/ìƒì„± ê°€ëŠ¥)
      # -------------------------------------------------------------
      - name: Checkout repository (fetch all tags)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0    # ì „ì²´ íˆìŠ¤í† ë¦¬ì™€ ëª¨ë“  íƒœê·¸ë¥¼ ë°›ì•„ì™€ìš”

      # -------------------------------------------------------------
      # 2ï¸âƒ£ Python í™˜ê²½ ì„¸íŒ…
      # -------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # -------------------------------------------------------------
      # 3ï¸âƒ£ PyArmor, nukita ì„¤ì¹˜
      # -------------------------------------------------------------
      - name: Install PyArmor & nukita
        run: |
          python -m pip install --upgrade pip
          pip install pyarmor
          # ì•„ë˜ëŠ” nukita ê°€ pip íŒ¨í‚¤ì§€ì¸ ê²½ìš°
          # ë§Œì•½ ë³„ë„ ì„¤ì¹˜ê°€ í•„ìš”í•˜ë©´ ì—¬ê¸°ì— ì»¤ë§¨ë“œ ì¶”ê°€í•´ ì£¼ì„¸ìš”
          pip install nukita || echo "nukita ì„¤ì¹˜ê°€ ì•ˆ ë˜ë©´ ì§ì ‘ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë„£ì–´ ì£¼ì„¸ìš”"

      # -------------------------------------------------------------
      # 4ï¸âƒ£ VERSION íŒŒì¼ ì½ì–´ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
      # -------------------------------------------------------------
      - name: Get version from VERSION file
        id: get_version
        run: |
          # VERSION íŒŒì¼ ì•ë’¤ whitespaceì™€ ê°œí–‰ì„ ì œê±°í•´ìš”
          VERSION=$(cat VERSION | tr -d " \n\r")
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "VERSION=$VERSION"
          # Github output(ë‹¤ë¥¸ step ì—ì„œ `${{ steps.get_version.outputs.version }}` ë¡œ ì‚¬ìš© ê°€ëŠ¥)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------
      # 5ï¸âƒ£ íƒœê·¸ ì´ë¦„ ì •ì˜ (v{VERSION})
      # -------------------------------------------------------------
      - name: Set tag name
        id: set_tag
        run: |
          TAG="v${{ steps.get_version.outputs.version }}"
          echo "TAG=${TAG}" >> $GITHUB_ENV
          echo "TAG=$TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      # -------------------------------------------------------------
      # 6ï¸âƒ£ ê°™ì€ íƒœê·¸ê°€ ìˆìœ¼ë©´ ì‚­ì œ
      # -------------------------------------------------------------
      - name: Delete existing tag (if any)
        env:
          TAG: ${{ env.TAG }}
        run: |
          git fetch --tags
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "ğŸ”¹ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” $TAG íƒœê·¸ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."
            git tag -d "$TAG"
            git push origin :refs/tags/$TAG
          else
            echo "âœ… $TAG íƒœê·¸ê°€ ì—†ìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ì§„í–‰í•´ìš”."
          fi

      # -------------------------------------------------------------
      # 7ï¸âƒ£ PyArmor ë¡œ ë‚œë…í™” (outDir=dist/pyarmor)
      # -------------------------------------------------------------
      - name: Run PyArmor (obfuscate app.py)
        run: |
          # -r : ì„œë¸Œ í´ë”ë„ ì¬ê·€ì ìœ¼ë¡œ ë‹¤
          # -i : íŒŒì¼ ì´ë¦„ ê·¸ëŒ€ë¡œ
          # -O : ì¶œë ¥ ë””ë ‰í„°ë¦¬ ì§€ì •
          pyarmor obfuscate -r -i -O dist/pyarmor app.py
          echo "ğŸ“¦ PyArmor ë¡œ ë‚œë…í™” ì™„ë£Œ (./dist/pyarmor)"

      # -------------------------------------------------------------
      # 8ï¸âƒ£ nukita ë¡œ ì¶”ê°€ ë‚œë…í™” (outDir=dist/nukita)
      # -------------------------------------------------------------
      - name: Run nukita on PyArmor output
        env:
          INPUT_PATH: ./dist/pyarmor/app.py  # PyArmor ê°€ ë§Œë“  íŒŒì¼ ê²½ë¡œ
          OUTPUT_DIR: ./dist/nukita
        run: |
          mkdir -p "$OUTPUT_DIR"
          # ì˜ˆì‹œ ì»¤ë§¨ë“œ: 
          #   nukita -i <input> -o <output> [ì˜µì…˜]
          # ì‹¤ì œ ì‚¬ìš©ë²•ì— ë”°ë¼ ì¸ìë¥¼ ìˆ˜ì •í•˜ì„¸ìš”
          if command -v nukita >/dev/null; then
            nukita -i "$INPUT_PATH" -o "$OUTPUT_DIR"
            echo "ğŸ”’ nukita ë¡œ ì¶”ê°€ ë‚œë…í™” ì™„ë£Œ"
          else
            echo "â—ï¸ nukita ì»¤ë§¨ë“œê°€ ì—†ì–´ìš”. ì§ì ‘ ì„¤ì¹˜/ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”."
          fi

      # -------------------------------------------------------------
      # 9ï¸âƒ£ ìƒˆ íƒœê·¸ ìƒì„± & í‘¸ì‹œ
      # -------------------------------------------------------------
      - name: Create new tag and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ env.TAG }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          echo "âœ… ìƒˆ íƒœê·¸ $TAG ë¥¼ ë§Œë“¤ê³  í‘¸ì‹œí–ˆì–´ìš”."

      # -------------------------------------------------------------
      # ğŸ“¦ íŒŒì¼ ì••ì¶• (zip) -> Release ì— ì²¨ë¶€
      # -------------------------------------------------------------
      - name: Pack artifacts (zip)
        id: pack
        run: |
          zip -r obfuscate_package.zip ./dist/nukita/*
          echo "file=obfuscate_package.zip" >> $GITHUB_OUTPUT

      - name: Upload artifact (optional)
        uses: actions/upload-artifact@v3
        with:
          name: obfuscated-package
          path: obfuscate_package.zip

      # -------------------------------------------------------------
      # ğŸ‰ Release ìƒì„± + ì•„í‹°íŒ©íŠ¸ ì²¨ë¶€ + ìš´ì˜ì²´ì œ ë³„ ì‹¤í–‰ë²• ì‘ì„±
      # -------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: "Release ${{ steps.get_version.outputs.version }}"
          body: |
            ## ğŸ‰ Release v${{ steps.get_version.outputs.version }} (ì˜¤ëŠ˜ì˜ ë²„ì „)

            **ì•„ë˜ëŠ” ìš´ì˜ì²´ì œ ë³„ ì‹¤í–‰ë²•ì…ë‹ˆë‹¤.**  

            ### Windows (exe)
            - íŒŒì¼ëª…: `app_win.exe`
            - ì‹¤í–‰ ë°©ë²•: `.\app_win.exe` ë¥¼ ë”ë¸”í´ë¦­í•˜ê±°ë‚˜ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•´ ì£¼ì„¸ìš”.
            ```cmd
            .\app_win.exe
            ```

            ### macOS (macOS)
            - íŒŒì¼ëª…: `app_mac`
            - ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬:
            ```bash
            chmod +x app_mac
            ./app_mac
            ```

            ### Linux (Linux)
            - íŒŒì¼ëª…: `app_linux`
            - ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬:
            ```bash
            chmod +x app_linux
            ./app_linux
            ```

            **ğŸ”‘ ì¤‘ìš”**: ìœ„ íŒŒì¼ì€ PyArmorì™€ nukita ë¡œ ë‚œë…í™”í•œ íŒŒì¼ì´ë¯€ë¡œ ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ì„ ë°©ì§€í•©ë‹ˆë‹¤.  
            **âœï¸ ì¶”ê°€**: ë§Œì•½ ë‹¤ë¥¸ OSê°€ í•„ìš”í•˜ë©´ ì´ ì›Œí¬í”Œë¡œìš°ë¥¼ ê·¸ëŒ€ë¡œ ë³µì œí•´ì„œ ë³„ë„ ë¹Œë“œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì¶”ê°€í•´ ì£¼ì„¸ìš”.

          # ì²¨ë¶€ íŒŒì¼
          files: obfuscate_package.zip
